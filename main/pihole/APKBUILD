# Contributor: Mike Crute <mike@crute.us>
# Contributor: Jonathan Krauss <jkrauss@asymworks.com>
# Maintainer: Jonathan Krauss <jkrauss@asymworks.com>
# 
# Custom version that omits the post-install Gravity update and includes extra
# logic to symlink the /etc/pihole directory to work on diskless installations
pkgname=pihole-diskless
pkgver=6.2.2
pkgrel=2
_webver=6.2.1 # Can also be out-of-sync with FTL
_scriptver=6.1.2 # Sometimes trails FTL and web
pkgdesc="A black hole for Internet advertisements"
url="https://pi-hole.net/"
arch="all"
license="EUPL-1.2"
# These are needed by the pihole script
depends="
	bash
	cmd:dig
	cmd:tput
	coreutils
	curl
	"
makedepends="
	cmake
	gmp-dev
	libidn2-dev
	libunistring-dev
	linux-headers
	mbedtls-dev
	ncurses-dev
	nettle-dev
	py3-requests
	python3
	readline-dev
	xxd
	"
checkdepends="
	bats-core
	bind-tools
	curl
	gdb
	ncurses
	shadow
	"
# check just doesn't work at all within the Alpine build system. It
# depends on listening on privileged ports and directing network traffic
# at itself. It can be made to work in isolated testing with the
# checkdepends above and these commands though.
options="!check"
pkggroups="pihole"
pkgusers="pihole"
install="
	$pkgname.pre-install
	$pkgname.post-upgrade
	"
subpackages="
	$pkgname-openrc
	$pkgname-doc
	$pkgname-bash-completion
	"
# Patches from:
# - https://github.com/mcrute/pihole-FTL	
# - https://github.com/mcrute/pi-hole
# To export patches for use here:
# - git format-patch --src-prefix="a/FTL-6.2.2/" --dst-prefix="b/FTL-6.2.2/" upstream/master..
# - git format-patch --src-prefix="a/pi-hole-6.1.2/" --dst-prefix="b/pi-hole-6.1.2/" upstream/master..
source="
	$pkgname-FTL-$pkgver.tar.gz::https://github.com/pi-hole/FTL/archive/refs/tags/v$pkgver.tar.gz
	$pkgname-web-$pkgver.tar.gz::https://github.com/pi-hole/web/archive/refs/tags/v$_webver.tar.gz
	$pkgname-scripts-$pkgver.tar.gz::https://github.com/pi-hole/pi-hole/archive/refs/tags/v$_scriptver.tar.gz

	pihole-update-gravity.crond
	pihole.confd
	pihole.initd

	0001-Support-printing-default-TOML-config.patch
	0002-Support-compiling-with-libcurses-instead-of-libtermc.patch
	0003-Support-configuring-file-paths.patch

	0001-Disallow-some-pihole-commands-for-Linux-distros.patch
	0002-Use-variables-for-path-roots.patch
	0003-Use-FHS-paths.patch
	0004-WIP-Change-some-paths-to-FHS.patch
	"
builddir="$srcdir"

build() {
	# Build FTL binary
	cmake \
		-DCMAKE_C_FLAGS="$CFLAGS" \
		-DCMAKE_INSTALL_PREFIX="/usr" \
		-DBUILD_SHARED_LIBS="True" \
		-DCMAKE_BUILD_TYPE="Release" \
		-DPIHOLE_STATE_PATH="/var/lib/pihole" \
		-DPIHOLE_SHARE_PATH="/usr/share/pihole" \
		-DPIHOLE_BIN_PATH="/usr/bin" \
		-DPIHOLE_WEB_PATH="/usr/share/pihole/admin-web" \
		-DPIHOLE_RUN_PATH="/run/pihole" \
		-B FTL-build \
		FTL-$pkgver

	# Embed build metadata in the FTL binary
	GIT_BRANCH="master" \
	GIT_VERSION="v$pkgver" \
	GIT_TAG="v$pkgver" \
		cmake --build FTL-build

	# Generate the default config file
	FTL-build/pihole-FTL --print-default-config > pihole.toml

	# Write the version file expected by several of the scripts
	{
		echo "CORE_VERSION=$_scriptver"
		echo "WEB_VERSION=$pkgver"
		echo "FTL_VERSION=$pkgver"
	} >> versions

	# Generate macvendor.db
	python3 FTL-$pkgver/tools/macvendor.py
}

package() {
	# Pihole needs to own /etc/pihole as well so it can write its
	# self-generated TLS certificates and the config file at first
	# startup.
	#
	# This is not great but there currently isn't a good way to generate
 	# and package the config file since the entire definition is in the
 	# C source. The file can be modified on the command line which will
 	# generate it but the filename is hardcoded to /etc/pihole/pihole.toml
 	# which can't be changed at runtime. Generating the config file would
 	# be a nice feature to have upstream so we can package it.
	install -d -m0755 -o pihole -g pihole \
		"$pkgdir"/etc/pihole \
		"$pkgdir"/var/log/pihole \
		"$pkgdir"/var/lib/pihole

	install -d -m0750 -o pihole -g pihole \
		"$pkgdir"/run/pihole

	# Install the FTL binary
	install -Dm755 "$srcdir"/FTL-build/pihole-FTL "$pkgdir"/usr/bin/pihole-FTL

	# Install generated MAC vendor database
	install -Dm666 "$srcdir"/macvendor.db "$pkgdir"/usr/share/pihole/macvendor.db

	# Install web control panel
	install -d -m0755 "$pkgdir"/usr/share/pihole/admin-web/
	cp -r "$srcdir"/web-$_webver/ "$pkgdir"/usr/share/pihole/admin-web/admin

	# Install management scripts
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/pihole "$pkgdir"/usr/bin/pihole
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/gravity.sh \
		"$pkgdir"/usr/share/pihole/gravity.sh

	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/version.sh \
		"$pkgdir"/usr/share/pihole/version.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/query.sh \
		"$pkgdir"/usr/share/pihole/query.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/api.sh \
		"$pkgdir"/usr/share/pihole/api.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/list.sh \
		"$pkgdir"/usr/share/pihole/list.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/piholeARPTable.sh \
		"$pkgdir"/usr/share/pihole/piholeARPTable.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/utils.sh \
		"$pkgdir"/usr/share/pihole/utils.sh
	install -Dm755 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/database_migration/gravity-db.sh \
		"$pkgdir"/usr/share/pihole/database_migration/gravity-db.sh
	install -Dm644 "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/COL_TABLE \
		"$pkgdir"/usr/share/pihole/COL_TABLE

	# These scripts are not installed because they are not supported for
	# distribution packages (they assume too much control over the system or
	# would overwrite binaries outside of the package manager).
	#
	# - advanced/Scripts/piholeCheckout.sh
	# - advanced/Scripts/piholeDebug.sh
	# - advanced/Scripts/piholeLogFlush.sh
	# - advanced/Scripts/update.sh
	# - advanced/Scripts/updatecheck.sh
	# - automated install/basic-install.sh
	# - automated install/uninstall.sh

	# Install update check cron job
	install -Dm755 pihole-update-gravity.crond \
		"$pkgdir"/etc/periodic/weekly/pihole-update-gravity

	# Install init script
	install -m755 -D "$srcdir"/pihole.initd "$pkgdir"/etc/init.d/pihole
	install -m755 -D "$srcdir"/pihole.confd "$pkgdir"/etc/conf.d/pihole

	# Install database migration files
	install -d -m0755 "$pkgdir"/usr/share/pihole/database_migration/gravity/
	cp -r "$srcdir"/pi-hole-$_scriptver/advanced/Scripts/database_migration/gravity/*.sql \
		"$pkgdir"/usr/share/pihole/database_migration/gravity/

	# Install template files
	install -Dm644 "$srcdir"/pi-hole-$_scriptver/advanced/Templates/gravity.db.sql \
		"$pkgdir"/usr/share/pihole/templates/gravity.db.sql
	install -Dm644 "$srcdir"/pi-hole-$_scriptver/advanced/Templates/gravity_copy.sql \
		"$pkgdir"/usr/share/pihole/templates/gravity_copy.sql

	# Install logrotate config
	install -D -m644 "$srcdir"/pi-hole-$_scriptver/advanced/Templates/logrotate \
		"$pkgdir"/etc/logrotate.d/pihole

	# Install bash completions
	install -Dm644 "$srcdir"/pi-hole-$_scriptver/advanced/bash-completion/pihole \
		"$pkgdir"/usr/share/bash-completion/completions/pihole

	# Install manpages
	install -Dm644 "$srcdir"/pi-hole-$_scriptver/manpages/pihole.8 \
		"$pkgdir"/usr/share/man/man8/pihole.8

	# Install the version and config file
	install -Dm644 "$srcdir"/versions "$pkgdir"/etc/pihole/versions
	install -Dm644 "$srcdir"/pihole.toml "$pkgdir"/etc/pihole/pihole.toml
}

